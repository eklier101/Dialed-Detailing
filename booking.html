<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book a Detailing – Dialed Detailing</title>
  <link rel="stylesheet" href="styles.css" />
  <style>.container{max-width:700px;margin:2rem auto;background:#fff;padding:1rem;border-radius:8px;} label{display:block;margin-top:0.6rem;}</style>
</head>
<body>
  <header>
    <h1>Book an Appointment</h1>
    <nav><a href="index.html">Home</a> <a href="admin.html">Admin</a></nav>
  </header>

  <main class="container">
    <form id="bookForm">
      <label>Name<input id="name" required /></label>
      <label>Email<input id="email" type="email" required /></label>
      <label>Phone<input id="phone" required /></label>

      <label>Vehicle
        <select id="vehicle"></select>
      </label>

      <label>Service
        <select id="service"></select>
      </label>

      <label>Add-Ons (ctrl/cmd+click to multi)
        <select id="addons" multiple size="3"></select>
      </label>

      <label>Date<input id="date" type="date" required /></label>

      <label>Time
        <select id="time"></select>
      </label>

      <button type="submit">Submit Booking</button>
    </form>

    <p id="msg"></p>
  </main>

<script>
const API_BASE = location.origin;

async function loadSettings() {
  try {
    const res = await fetch('/settings');
    if (!res.ok) throw new Error('No settings');
    const data = await res.json();

    const vehicle = document.getElementById('vehicle');
    const service = document.getElementById('service');
    const addons = document.getElementById('addons');
    const time = document.getElementById('time');

    vehicle.innerHTML = '';
    service.innerHTML = '';
    addons.innerHTML = '';
    time.innerHTML = '';

    data.vehicleTypes.forEach(v => vehicle.insertAdjacentHTML('beforeend', `<option>${v}</option>`));
    data.services.forEach(s => service.insertAdjacentHTML('beforeend', `<option>${s.name}</option>`));
    data.addons.forEach(a => addons.insertAdjacentHTML('beforeend', `<option>${a.name} (+$${a.price})</option>`));
    data.availableTimes.forEach(t => time.insertAdjacentHTML('beforeend', `<option>${t}</option>`));
  } catch(e) {
    document.getElementById('msg').textContent = 'Failed to load booking settings.';
  }
}

document.getElementById('bookForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const data = {
    name: document.getElementById('name').value.trim(),
    email: document.getElementById('email').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    vehicle: document.getElementById('vehicle').value,
    service: document.getElementById('service').value,
    addons: Array.from(document.getElementById('addons').selectedOptions).map(o=>o.value),
    date: document.getElementById('date').value,
    time: document.getElementById('time').value
  };
  document.getElementById('msg').textContent = 'Submitting...';
  try {
    const res = await fetch('/book', {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const payload = await res.json();
    if (payload.ok) {
      document.getElementById('msg').textContent = 'Thanks — booking received. We will contact you to confirm.';
      document.getElementById('bookForm').reset();
    } else {
      document.getElementById('msg').textContent = 'Failed: ' + (payload.message || 'unknown');
    }
  } catch (e) {
    document.getElementById('msg').textContent = 'Error: ' + e.message;
  }
});

loadSettings();
</script>
</body>
</html>
